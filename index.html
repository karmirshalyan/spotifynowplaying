<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotify Now Playing</title>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Nunito', sans-serif;
        overflow: hidden;
        background: #000;
        color: white;
        min-height: 100vh; 
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative; 
    }

    #blur-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-size: cover;
        background-position: center;
        filter: blur(40px) brightness(0.4);
        z-index: -1;
        transform: scale(1.2);
        transition: background-image 0.5s ease;
    }

    #vinyl-container {
        position: relative; 
        width: min(500px, 90vmin);
        height: min(500px, 90vmin);
        border-radius: 50%;
        background: radial-gradient(#111 0%, #000 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        z-index: 2;
    }

    #albumImage {
        width: 84%;
        height: 84%;
        border-radius: 50%;
        object-fit: cover;
        transition: opacity 0.4s ease;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spinning {
        animation: spin 12s linear infinite;
    }

    .paused {
        animation-play-state: paused;
    }
    
    #song-info {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        z-index: 3;
        width: 90%;
        max-width: 600px;
        word-wrap: break-word;
    }

    #artistName {
        font-size: 20px;
        opacity: 0.7;
        margin-top: 4px;
    }

    .lyric-floating {
        position: absolute;
        font-size: 22px;
        opacity: 0;
        white-space: nowrap;
        pointer-events: none;
        color: #fff;
        text-shadow: 0 0 5px #fff;
        z-index: 1;
        transition: all 1s ease;
    }

    .lyric-active {
        opacity: 1 !important;
        transform: scale(1.3);
        text-shadow: 0 0 25px #fff;
    }
</style>
</head>
<body>

<div id="blur-bg"></div>

<div id="vinyl-container">
    <img id="albumImage" src="" />
</div>

<div id="song-info">
    <div id="trackName">Track</div>
    <div id="artistName">Artist</div>
</div>

<script>
const client_id = "ca2b2a8fbe6c4adf9357b81a525ca490";
const redirect_uri = "https://karmirshalyan.github.io/spotifynowplaying/";
const scopes = ["user-read-currently-playing", "user-read-playback-state", "streaming"];

let currentAlbum = '';
let lyrics = [];
let playbackStartTime = 0;
let duration = 0;
let isPaused = false;
let lastTrackId = "";

// --- TOKEN HANDLING ---
function getAccessToken() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
}

function redirectToAuth() {
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scopes.join(' '))}`;
    window.location.href = authUrl;
}

// --- CLEAR OLD LYRICS ---
function clearLyrics() {
    const old = document.querySelectorAll('.lyric-floating');
    old.forEach(el => el.remove());
}

// --- LYRIC SCATTERING ---
function scatterLyrics() {
    clearLyrics();

    lyrics.forEach((line, index) => {
        const span = document.createElement("div");
        span.className = "lyric-floating";
        span.id = `lyric-${index}`;
        span.textContent = line.text;

        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        let x, y;
        do {
            x = Math.random() * screenWidth;
            y = Math.random() * screenHeight;
            const dx = x - screenWidth/2;
            const dy = y - screenHeight/2;
            var distance = Math.sqrt(dx*dx + dy*dy);
        } while(distance < 180);

        span.style.left = x + "px";
        span.style.top = y + "px";
        span.style.opacity = 0;

        document.body.appendChild(span);

        setTimeout(() => {
            span.style.opacity = 0.12;
        }, 100 * index);
    });
}

// --- HIGHLIGHT CURRENT LYRIC ---
function highlightLyric(currentIndex) {
    document.querySelectorAll('.lyric-floating').forEach(el => el.classList.remove('lyric-active'));
    const active = document.getElementById(`lyric-${currentIndex}`);
    if(active) active.classList.add('lyric-active');
}

// --- PARSE LRC ---
function parseLRC(lrc) {
    const lines = lrc.split("\n");
    const result = [];
    
    for (const line of lines) {
        const timeMatches = line.matchAll(/\[(\d+):(\d+\.\d+)\]/g);
        const text = line.replace(/\[.*?\]/g, '').trim();
        
        if (!text) continue;
        
        for (const match of timeMatches) {
            const minutes = parseFloat(match[1]);
            const seconds = parseFloat(match[2]);
            const time = minutes * 60 + seconds;
            result.push({ time, text });
        }
    }
    
    result.sort((a, b) => a.time - b.time);
    return result;
}

// --- UPDATE LYRICS ---
function updateLyrics() {
    if(!lyrics.length || isPaused) return;
    const now = (Date.now() - playbackStartTime)/1000;
    const idx = lyrics.findIndex(l => l.time > now) - 1;
    if(idx >= 0) highlightLyric(idx);
}

// --- FETCH CURRENT SONG ---
function fetchSong(token) {
    fetch('https://api.spotify.com/v1/me/player/currently-playing', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => {
        if (res.status === 204) {
            // No content - no song playing
            clearLyrics();
            lastTrackId = "";
            document.getElementById('trackName').textContent = "No track playing";
            document.getElementById('artistName').textContent = "";
            return null;
        }
        return res.json();
    })
    .then(data => {
        if(!data || !data.item) {
            clearLyrics();
            lastTrackId = "";
            return;
        }

        const track = data.item;

        // Если трек сменился
        if(track.id !== lastTrackId) {
            lastTrackId = track.id;
            lyrics = [];
            clearLyrics();
            
            // Fetch lyrics for new track
            fetchLyrics(track.name, track.artists[0].name, track.album.name, track.duration_ms / 1000);
        }

        duration = track.duration_ms / 1000;
        playbackStartTime = Date.now() - data.progress_ms;
        isPaused = !data.is_playing;

        document.getElementById('trackName').textContent = track.name;
        document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', ');

        const cover = track.album.images[0].url;
        if(cover !== currentAlbum) {
            currentAlbum = cover;
            const albumImg = document.getElementById('albumImage');
            albumImg.style.opacity = 0;
            setTimeout(() => {
                albumImg.src = cover;
                albumImg.style.opacity = 1;
                document.getElementById('blur-bg').style.backgroundImage = `url(${cover})`;
            }, 300);
        }

        updateRotation();
    })
    .catch(e => console.log('Error fetching song:', e));
}

// --- UPDATE ROTATION ---
function updateRotation() {
    const vinyl = document.getElementById('vinyl-container');
    if(!isPaused){
        vinyl.classList.add('spinning');
        vinyl.classList.remove('paused');
    } else {
        vinyl.classList.add('paused');
    }
}

// --- FETCH LYRICS ---
function fetchLyrics(track, artist, album, duration){
    const url = `https://lrclib.net/api/get?track_name=${encodeURIComponent(track)}&artist_name=${encodeURIComponent(artist)}&album_name=${encodeURIComponent(album)}&duration=${duration}`;
    
    fetch(url)
    .then(r => {
        if (!r.ok) throw new Error('Lyrics not found');
        return r.json();
    })
    .then(data => {
        if(data && data.syncedLyrics) {
            lyrics = parseLRC(data.syncedLyrics);
            scatterLyrics();
        } else {
            lyrics = [];
            clearLyrics();
        }
    })
    .catch(e => {
        console.log('Lyrics error:', e);
        lyrics = [];
        clearLyrics();
    });
}

// --- INIT ---
let token = getAccessToken();

if(!token) {
    redirectToAuth();
} else {
    setInterval(() => fetchSong(token), 1500);
    setInterval(updateLyrics, 500);
}
</script>
</body>
</html>
